name: Self-Service Create Cluster

on:
  issues:
    types: [labeled]

jobs:
  create-cluster:
    if: github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, 'cluster-create')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Issue
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            const getValue = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*(.+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            core.setOutput('cluster_name', getValue('Cluster Name'));
            core.setOutput('environment', getValue('Environment'));
            core.setOutput('zone', getValue('GCP Zone'));
            core.setOutput('node_count', getValue('Number of Nodes'));
            core.setOutput('machine_type', getValue('Machine Type'));
            core.setOutput('team', getValue('Team Name'));
            core.setOutput('owner_email', getValue('Owner Email'));

      - name: Generate Cluster Files
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          CLUSTER="${{ steps.parse.outputs.cluster_name }}"
          
          mkdir -p clusters/$CLUSTER
          
          # Create cluster.yaml
          cat <<YAML > clusters/$CLUSTER/cluster.yaml
          cluster:
            name: $CLUSTER
            environment: ${{ steps.parse.outputs.environment }}
            owner: ${{ steps.parse.outputs.owner_email }}
            created_at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            created_by: ${{ github.event.issue.user.login }}
          
          infrastructure:
            zone: ${{ steps.parse.outputs.zone }}
            node_count: ${{ steps.parse.outputs.node_count }}
            machine_type: ${{ steps.parse.outputs.machine_type }}
            disk_size: 30
          
          labels:
            team: ${{ steps.parse.outputs.team }}
            environment: ${{ steps.parse.outputs.environment }}
            managed-by: terraform
          
          tags:
            - ${{ steps.parse.outputs.team }}
            - ${{ steps.parse.outputs.environment }}
          YAML
          
          # Create main.tf with GCS backend
          cat <<TERRAFORM > clusters/$CLUSTER/main.tf
          terraform {
            required_version = ">= 1.0"
            
            backend "gcs" {
              bucket = "$GCP_PROJECT_ID-tf-state"
              prefix = "clusters/$CLUSTER"
            }
            
            required_providers {
              google = {
                source  = "hashicorp/google"
                version = "~> 5.0"
              }
            }
          }
          
          provider "google" {
            project = var.project_id
          }
          
          locals {
            config = yamldecode(file("\${path.module}/cluster.yaml"))
          }
          
          module "gke_cluster" {
            source = "../../modules/gke-cluster"
            project_id   = var.project_id
            cluster_name = local.config.cluster.name
            zone         = local.config.infrastructure.zone
            node_count   = local.config.infrastructure.node_count
            machine_type = local.config.infrastructure.machine_type
            disk_size    = local.config.infrastructure.disk_size
            labels       = local.config.labels
            tags         = local.config.tags
          }
          
          output "cluster_name" {
            value = module.gke_cluster.cluster_name
          }
          
          output "cluster_zone" {
            value = module.gke_cluster.cluster_zone
          }
          
          output "get_credentials_command" {
            value = module.gke_cluster.get_credentials_command
          }
          TERRAFORM
          
          # Create variables.tf
          cat <<VARIABLES > clusters/$CLUSTER/variables.tf
          variable "project_id" {
            description = "GCP Project ID"
            type        = string
            default     = "$GCP_PROJECT_ID"
          }
          VARIABLES

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "Create cluster: ${{ steps.parse.outputs.cluster_name }}"
          title: "[Create] ${{ steps.parse.outputs.cluster_name }}"
          body: |
            ##  New Cluster
            
            Auto-generated from issue #${{ github.event.issue.number }}
            
            | Setting | Value |
            |---------|-------|
            | **Cluster** | ${{ steps.parse.outputs.cluster_name }} |
            | **Environment** | ${{ steps.parse.outputs.environment }} |
            | **Zone** | ${{ steps.parse.outputs.zone }} |
            | **Nodes** | ${{ steps.parse.outputs.node_count }} |
            | **Machine Type** | ${{ steps.parse.outputs.machine_type }} |
            
            Closes #${{ github.event.issue.number }}
          branch: "${{ steps.parse.outputs.cluster_name }}-${{ steps.parse.outputs.environment }}-${{ secrets.GCP_PROJECT_ID }}-${{ github.event.issue.number }}"
          labels: infrastructure

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Approved!** PR created to provision your cluster.'
            });
