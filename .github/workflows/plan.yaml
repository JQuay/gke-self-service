name: Terraform Plan

on:
  pull_request:
    branches:
      - main
    paths:
      - 'clusters/**'
    #   - 'modules/**'

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Find Clusters
        id: clusters
        run: |
          CLUSTERS=$(find clusters -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | grep -v ".gitkeep" | tr '\n' ' ')
          echo "clusters=$CLUSTERS" >> $GITHUB_OUTPUT

      - name: Terraform Plan
        id: plan
        run: |
          for cluster in ${{ steps.clusters.outputs.clusters }}; do
            if [ -f "clusters/$cluster/main.tf" ]; then
              echo "=== Planning: $cluster ==="
              cd clusters/$cluster
              terraform init
              terraform plan -no-color 2>&1 | tee plan.txt
              cd ../..
            fi
          done

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const clusters = '${{ steps.clusters.outputs.clusters }}'.split(' ').filter(c => c);
            
            let body = '## Terraform Plan\n\n';
            
            for (const cluster of clusters) {
              const planPath = `clusters/${cluster}/plan.txt`;
              if (fs.existsSync(planPath)) {
                const plan = fs.readFileSync(planPath, 'utf8');
                body += `### Cluster: \`${cluster}\`\n\n`;
                body += '```hcl\n' + plan.slice(-4000) + '\n```\n\n';
              }
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });